<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#166534">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Ganaderias Proyma | Mapa Interactivo</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <style>
        :root {
            --primary: #166534;
            --primary-light: #22c55e;
            --primary-50: #f0fdf4;
            --primary-100: #dcfce7;
            --primary-600: #16a34a;
            --primary-700: #15803d;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            --safe-bottom: env(safe-area-inset-bottom, 0px);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        html, body {
            height: 100%;
            overflow: hidden;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #f8fafc;
            -webkit-font-smoothing: antialiased;
        }

        /* ========== DESKTOP LAYOUT ========== */
        .app {
            display: flex;
            height: 100vh;
            height: 100dvh;
        }

        .sidebar {
            width: 400px;
            min-width: 400px;
            background: white;
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--gray-200);
            z-index: 100;
        }

        .sidebar-header {
            padding: 24px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-700) 100%);
            color: white;
        }

        .sidebar-header h1 {
            font-size: 1.5rem;
            font-weight: 800;
            margin-bottom: 4px;
        }

        .sidebar-header p {
            font-size: 0.875rem;
            opacity: 0.9;
        }

        .search-section {
            padding: 16px;
            background: white;
            border-bottom: 1px solid var(--gray-100);
        }

        .search-box {
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding: 14px 44px 14px 44px;
            border: 2px solid var(--gray-200);
            border-radius: 12px;
            font-size: 1rem;
            font-family: inherit;
            background: var(--gray-50);
            transition: all 0.2s;
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--primary-600);
            background: white;
            box-shadow: 0 0 0 3px rgba(22, 163, 74, 0.1);
        }

        .search-box .icon-search {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-400);
            pointer-events: none;
        }

        .search-box .btn-clear {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            width: 28px;
            height: 28px;
            border: none;
            background: var(--gray-200);
            border-radius: 50%;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            color: var(--gray-600);
        }

        .search-box .btn-clear.show { display: flex; }
        .search-box .btn-clear:hover { background: var(--gray-300); }

        .filters {
            padding: 12px 16px;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            background: var(--gray-50);
            border-bottom: 1px solid var(--gray-100);
        }

        .filter-btn {
            padding: 8px 16px;
            border: 1px solid var(--gray-200);
            background: white;
            border-radius: 100px;
            font-size: 0.8125rem;
            font-weight: 500;
            color: var(--gray-600);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .filter-btn:hover {
            border-color: var(--primary-600);
            color: var(--primary-700);
        }

        .filter-btn.active {
            background: var(--primary-600);
            border-color: var(--primary-600);
            color: white;
        }

        .filter-btn .count {
            font-size: 0.6875rem;
            padding: 2px 6px;
            background: rgba(0,0,0,0.08);
            border-radius: 100px;
        }

        .filter-btn.active .count {
            background: rgba(255,255,255,0.2);
        }

        .results-bar {
            padding: 12px 16px;
            font-size: 0.8125rem;
            color: var(--gray-500);
            background: white;
            border-bottom: 1px solid var(--gray-100);
        }

        .results-bar strong {
            color: var(--primary-700);
            font-weight: 700;
        }

        .list-container {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
        }

        .list-item {
            background: white;
            border: 1px solid var(--gray-100);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .list-item:hover {
            border-color: var(--primary-200);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        .list-item.active {
            border-color: var(--primary-600);
            background: var(--primary-50);
        }

        .list-item-header {
            display: flex;
            gap: 12px;
            align-items: flex-start;
        }

        .list-item-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary-100), var(--primary-200));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .list-item-icon svg {
            width: 20px;
            height: 20px;
            color: var(--primary-700);
        }

        .list-item-content {
            flex: 1;
            min-width: 0;
        }

        .list-item-name {
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 4px;
            font-size: 0.9375rem;
        }

        .list-item-location {
            font-size: 0.8125rem;
            color: var(--gray-500);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .list-item-location svg {
            width: 14px;
            height: 14px;
            flex-shrink: 0;
        }

        .list-item-actions {
            margin-top: 12px;
        }

        .btn-maps {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: #4285f4;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.8125rem;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            transition: background 0.2s;
        }

        .btn-maps:hover { background: #1a73e8; }
        .btn-maps svg { width: 16px; height: 16px; }

        /* ========== MAP ========== */
        .map-container {
            flex: 1;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .map-controls {
            position: absolute;
            top: 16px;
            right: 16px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .map-btn {
            width: 44px;
            height: 44px;
            background: white;
            border: none;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--gray-700);
            transition: all 0.2s;
        }

        .map-btn:hover {
            background: var(--gray-50);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .map-btn svg { width: 20px; height: 20px; }

        /* Leaflet customization */
        .leaflet-control-zoom {
            border: none !important;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15) !important;
            border-radius: 12px !important;
            overflow: hidden;
        }

        .leaflet-control-zoom a {
            width: 40px !important;
            height: 40px !important;
            line-height: 40px !important;
            font-size: 18px !important;
            color: var(--gray-700) !important;
            border: none !important;
        }

        .leaflet-popup-content-wrapper {
            border-radius: 16px !important;
            padding: 0 !important;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2) !important;
        }

        .leaflet-popup-content { margin: 0 !important; }

        .popup-inner {
            padding: 20px;
            min-width: 260px;
        }

        .popup-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--gray-100);
        }

        .popup-icon {
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, var(--primary-600), var(--primary-700));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .popup-icon svg { width: 22px; height: 22px; }

        .popup-title h3 {
            font-size: 1rem;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 2px;
        }

        .popup-title p {
            font-size: 0.8125rem;
            color: var(--gray-500);
        }

        .popup-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            padding: 14px;
            background: #4285f4;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 0.9375rem;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
        }

        .popup-btn:hover { background: #1a73e8; }
        .popup-btn svg { width: 18px; height: 18px; }

        /* Custom marker */
        .marker-pin {
            width: 24px;
            height: 32px;
            position: relative;
        }

        .marker-pin::before {
            content: '';
            position: absolute;
            width: 24px;
            height: 24px;
            background: var(--primary-600);
            border: 2px solid white;
            border-radius: 50% 50% 50% 0;
            transform: rotate(-45deg);
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            left: 0;
            top: 0;
        }

        .marker-pin::after {
            content: '';
            position: absolute;
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 50%;
            left: 8px;
            top: 6px;
        }

        .marker-pin.active::before {
            background: #f59e0b;
        }

        /* Cluster styles */
        .marker-cluster {
            background: rgba(22, 163, 74, 0.2);
            border-radius: 50%;
        }

        .marker-cluster div {
            background: var(--primary-600);
            color: white;
            font-weight: 700;
            font-size: 12px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .marker-cluster-small {
            width: 36px;
            height: 36px;
        }
        .marker-cluster-small div {
            width: 28px;
            height: 28px;
            margin: 4px;
        }

        .marker-cluster-medium {
            width: 44px;
            height: 44px;
        }
        .marker-cluster-medium div {
            width: 34px;
            height: 34px;
            margin: 5px;
        }

        .marker-cluster-large {
            width: 52px;
            height: 52px;
        }
        .marker-cluster-large div {
            width: 40px;
            height: 40px;
            margin: 6px;
        }

        /* ========== MOBILE LAYOUT ========== */
        .mobile-nav {
            display: none;
        }

        @media (max-width: 768px) {
            .app {
                flex-direction: column;
            }

            .sidebar {
                display: flex;
                width: 100%;
                min-width: 100%;
                height: calc(100% - 60px);
                position: fixed;
                top: 0;
                left: 0;
                z-index: 200;
            }

            .sidebar.hide {
                display: none;
            }

            .sidebar-header {
                padding: 16px 20px;
            }

            .sidebar-header h1 {
                font-size: 1.25rem;
            }

            .search-section {
                padding: 12px 16px;
            }

            .search-box input {
                padding: 12px 40px 12px 40px;
                font-size: 0.9375rem;
            }

            .filters {
                padding: 10px 16px;
                gap: 6px;
            }

            .filter-btn {
                padding: 6px 12px;
                font-size: 0.75rem;
            }

            .results-bar {
                padding: 10px 16px;
                font-size: 0.75rem;
            }

            .list-container {
                padding: 10px;
            }

            .list-item {
                padding: 14px;
                margin-bottom: 8px;
            }

            .list-item-icon {
                width: 36px;
                height: 36px;
            }

            .list-item-icon svg {
                width: 18px;
                height: 18px;
            }

            .list-item-name {
                font-size: 0.875rem;
            }

            .list-item-location {
                font-size: 0.75rem;
            }

            .btn-maps {
                width: 100%;
                justify-content: center;
                padding: 12px;
            }

            .map-container {
                height: calc(100% - 60px);
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                display: none;
            }

            .map-container.show {
                display: block;
            }

            .map-controls {
                top: 12px;
                right: 12px;
            }

            .map-btn {
                width: 40px;
                height: 40px;
            }

            /* Mobile bottom navigation */
            .mobile-nav {
                display: flex;
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                height: 60px;
                padding-bottom: var(--safe-bottom);
                background: white;
                border-top: 1px solid var(--gray-200);
                z-index: 300;
                box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
            }

            .mobile-nav-btn {
                flex: 1;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                gap: 4px;
                border: none;
                background: none;
                color: var(--gray-400);
                font-size: 0.6875rem;
                font-weight: 600;
                cursor: pointer;
                transition: color 0.2s;
            }

            .mobile-nav-btn.active {
                color: var(--primary-600);
            }

            .mobile-nav-btn svg {
                width: 24px;
                height: 24px;
            }

            /* Popup mobile */
            .popup-inner {
                padding: 16px;
                min-width: 220px;
            }

            .popup-header {
                margin-bottom: 12px;
                padding-bottom: 12px;
            }

            .popup-icon {
                width: 38px;
                height: 38px;
            }

            .popup-title h3 {
                font-size: 0.9375rem;
            }

            .popup-btn {
                padding: 12px;
                font-size: 0.875rem;
            }
        }

        /* Prevent iOS bounce */
        @supports (-webkit-touch-callout: none) {
            .list-container {
                -webkit-overflow-scrolling: touch;
            }
        }
    </style>
</head>
<body>
    <div class="app">
        <!-- Sidebar (Lista) -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h1>Ganaderias Proyma</h1>
                <p>Mapa interactivo de localizaciones</p>
            </div>

            <div class="search-section">
                <div class="search-box">
                    <svg class="icon-search" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
                    </svg>
                    <input type="text" id="searchInput" placeholder="Buscar ganaderia..." aria-label="Buscar ganadería por nombre" autocomplete="off">
                    <button class="btn-clear" id="btnClear">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M18 6L6 18M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
            </div>

            <div class="filters" id="filters" role="group" aria-label="Filtrar por provincia"></div>

            <div class="results-bar">
                <span id="resultsCount">Cargando...</span>
            </div>

            <div class="list-container" id="listContainer" role="list" aria-label="Lista de ganaderías"></div>
        </aside>

        <!-- Map -->
        <main class="map-container" id="mapContainer">
            <div id="map"></div>
            <div class="map-controls">
                <button class="map-btn" id="btnLocation" title="Mi ubicación">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"/><path d="M12 2v3m0 14v3M2 12h3m14 0h3"/>
                    </svg>
                </button>
                <button class="map-btn" id="btnCenter" title="Centrar mapa">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="3"/>
                    </svg>
                </button>
                <button class="map-btn" id="btnFit" title="Ver todas">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7"/>
                    </svg>
                </button>
            </div>
        </main>

        <!-- Mobile Navigation -->
        <nav class="mobile-nav">
            <button class="mobile-nav-btn" id="navMap" data-view="map">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/><circle cx="12" cy="10" r="3"/>
                </svg>
                <span>Mapa</span>
            </button>
            <button class="mobile-nav-btn active" id="navList" data-view="list">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M8 6h13M8 12h13M8 18h13M3 6h.01M3 12h.01M3 18h.01"/>
                </svg>
                <span>Lista</span>
            </button>
        </nav>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <script>
        // ========== DATA ==========
        const ganaderias = [
            { nombre: "Agropecuarias Padilla", lat: 39.060806, lng: -2.266639 },
            { nombre: "Agromembrilla", lat: 38.974500, lng: -3.332667 },
            { nombre: "Agrovilla", lat: 39.613444, lng: -3.196528 },
            { nombre: "Agustin Moral Mena", lat: 39.6500, lng: -2.5833, direccion: "16422 Tresjuncos, Cuenca" },
            { nombre: "Agustin Moreno", lat: 39.224722, lng: -3.763167 },
            { nombre: "Albavi", lat: 38.7500, lng: -2.1667, direccion: "C. Belen, 6, 02161 Tiriez, Albacete" },
            { nombre: "Aldea del Rey, Jorge y Prado", lat: 38.620556, lng: -3.689472 },
            { nombre: "Alejandro Bonilla", lat: 40.168611, lng: -2.680472 },
            { nombre: "Ampaber Finca La Rana", lat: 38.907944, lng: -4.182861 },
            { nombre: "Angel De La Fuente", lat: 40.192917, lng: -2.778889 },
            { nombre: "Angel Gutierrez", lat: 39.085444, lng: -3.068056 },
            { nombre: "Antonio Fresneda", lat: 38.544250, lng: -3.006056 },
            { nombre: "Antonio Rabadan", lat: 39.4167, lng: -3.5500, direccion: "C. Manuel Rodriguez, 67, 45480 Urda" },
            { nombre: "Bauti Mota del Cuervo", lat: 39.5000, lng: -2.8667, direccion: "C. Felicidad, 3, 16630 Mota del Cuervo" },
            { nombre: "Bauti Villanueva de Alcardete", lat: 39.683778, lng: -3.035389 },
            { nombre: "Belmonte, Damian", lat: 39.550972, lng: -2.719278 },
            { nombre: "Benito Pozohondo", lat: 38.732111, lng: -1.907667 },
            { nombre: "Camino Bueno Manuel Florencio", lat: 39.180917, lng: -3.992444 },
            { nombre: "Camino Finca Navalcaballo (Campo Ovino) GB", lat: 38.840972, lng: -2.813250 },
            { nombre: "Campo Ovino (Guija) Villarrobledo", lat: 39.257556, lng: -2.452861 },
            { nombre: "Carprariza", lat: 39.393333, lng: -3.740556 },
            { nombre: "Casa del Conde", lat: 39.017722, lng: -3.432333 },
            { nombre: "Casa Los Majines (Consuegra)", lat: 39.463000, lng: -3.604611 },
            { nombre: "Castillo Villora", lat: 39.093028, lng: -2.476556 },
            { nombre: "Castuera 1", lat: 38.753389, lng: -5.542444 },
            { nombre: "Castuera 2", lat: 38.712333, lng: -5.601306 },
            { nombre: "Cimasa", lat: 39.193361, lng: -2.142472 },
            { nombre: "Ciudad Caballero", lat: 38.7833, lng: -3.8333, direccion: "CM-413, PK 28, 5, 13380 Aldea del Rey" },
            { nombre: "Clagor", lat: 39.218639, lng: -2.639306 },
            { nombre: "Clinica Villarrubia", lat: 39.223139, lng: -3.604972, direccion: "Paseo del Cordon" },
            { nombre: "Comercial de Ovino Manchego", lat: 39.1833, lng: -1.7667, direccion: "02240 Mahora, Albacete" },
            { nombre: "Conrado Lopez", lat: 39.601111, lng: -2.214417 },
            { nombre: "Consabrum", lat: 39.478167, lng: -3.754556 },
            { nombre: "Coop. Fuente el Fresno", lat: 39.2167, lng: -3.7000, direccion: "Cam. de Cdad. Real, 21" },
            { nombre: "Cosme Javier (Horcajo)", lat: 39.3000, lng: -4.6000, direccion: "Horcajo de los Montes" },
            { nombre: "Daniel Talavera (Inaga)", lat: 39.956056, lng: -4.874389 },
            { nombre: "David Alcazar (Villahermosa)", lat: 38.748500, lng: -2.820194 },
            { nombre: "Domingo Laguna", lat: 39.605972, lng: -3.625444 },
            { nombre: "Edificio Multiusos", lat: 39.2500, lng: -3.2000 },
            { nombre: "El Canavate, Jesus", lat: 39.518611, lng: -2.263389 },
            { nombre: "El Charcon", lat: 39.693194, lng: -3.593056 },
            { nombre: "El Jaron 2", lat: 38.612167, lng: -3.127278 },
            { nombre: "Emiliano Serrano", lat: 39.2167, lng: -3.7000, direccion: "C. Pio XII, 48, 13680 Fuente el Fresno" },
            { nombre: "Emilio Jose Garcia-Miguel (Madridejos)", lat: 39.515639, lng: -3.534361 },
            { nombre: "Emilio Poveda", lat: 39.180222, lng: -2.941750 },
            { nombre: "Enrique Navajas", lat: 39.3000, lng: -3.1000, direccion: "Lugar Diseminado, 18A" },
            { nombre: "ES Porras", lat: 39.719778, lng: -2.837500 },
            { nombre: "Eugenio Fernandez (Retjerta)", lat: 39.456944, lng: -4.407889 },
            { nombre: "Eugenio Poveda, Cinco Casas", lat: 39.161778, lng: -3.181861 },
            { nombre: "Felipe Garcia Esteban", lat: 39.318944, lng: -4.064500 },
            { nombre: "Felipe Sanchez Crespo", lat: 39.217667, lng: -3.632778 },
            { nombre: "Fernando Benito (El Robledillo)", lat: 39.5167, lng: -4.3333, direccion: "San Pablo de los Montes" },
            { nombre: "Fervapor", lat: 39.4167, lng: -3.5500, direccion: "C. Donantes de Sangre, 5, 45480 Urda" },
            { nombre: "Finca La Nava", lat: 38.8833, lng: -3.7167, direccion: "13270 Almagro" },
            { nombre: "Finca La Venta (Paraje de San Huberto)", lat: 39.1667, lng: -3.5000, direccion: "Entrada camino CM-4112, 7" },
            { nombre: "Francisco Alhambra", lat: 38.880472, lng: -3.263444 },
            { nombre: "Francisco Javier Gines Anguita", lat: 38.844917, lng: -4.247417 },
            { nombre: "Francisca Atencia, Munera", lat: 38.9500, lng: -2.4833, direccion: "02612 Munera, Albacete" },
            { nombre: "Frisones Verbo", lat: 39.4500, lng: -3.6000, direccion: "Camino de los Cerros, 45700 Consuegra" },
            { nombre: "Gallego Sanz", lat: 39.665056, lng: -3.015361 },
            { nombre: "Gantomar", lat: 39.493278, lng: -3.708028 },
            { nombre: "Garin Cobian", lat: 38.975500, lng: -4.022778 },
            { nombre: "Gomez Moreno", lat: 39.157083, lng: -3.361278 },
            { nombre: "Granja San Joaquin", lat: 39.3500, lng: -3.0000, direccion: "Granja San Joaquin" },
            { nombre: "Herederos de Jeronimo Alcaide", lat: 38.732722, lng: -3.839167 },
            { nombre: "Herederos de Vicente Barrera", lat: 39.087833, lng: -2.409722 },
            { nombre: "Hermanos Jimenez (Santa Cruz de la Zarza)", lat: 39.957639, lng: -3.174306 },
            { nombre: "Hermanos Lozano", lat: 39.2000, lng: -3.4500, direccion: "Diseminado Diseminados, 1" },
            { nombre: "Hermanos Martinez", lat: 39.353361, lng: -2.975833 },
            { nombre: "Hermanos Monsalve", lat: 38.843694, lng: -4.096806 },
            { nombre: "Hermanos Osorio", lat: 39.735611, lng: -2.919389 },
            { nombre: "Hermanos Parra, Pozo La Serna", lat: 38.779556, lng: -3.229472 },
            { nombre: "Hermanos Perez Juana", lat: 39.7500, lng: -3.1500, direccion: "C. Azucena, 4, 45880 Corral de Almaguer" },
            { nombre: "Hermanos Rodriguez Capitan", lat: 39.768861, lng: -3.195500 },
            { nombre: "Hijos de Lazaro Pavon", lat: 39.463667, lng: -4.407083 },
            { nombre: "Ignacio Olivares Campo", lat: 39.6167, lng: -2.3833, direccion: "C. Camarillas, 55, Santa Maria del Campo Rus" },
            { nombre: "Isidro Fernandez", lat: 39.7167, lng: -2.6667, direccion: "16431 Almonacid del Marquesado" },
            { nombre: "Ismael Jimenez", lat: 39.161139, lng: -4.136389 },
            { nombre: "Ivan Melero", lat: 39.589306, lng: -2.691806 },
            { nombre: "Javier Fernandez Rojo", lat: 40.199861, lng: -2.775917 },
            { nombre: "Jesus Gallego (Villahermosa)", lat: 38.745028, lng: -2.861194 },
            { nombre: "Joaquin Delgado (Belmonte)", lat: 39.568139, lng: -2.713806 },
            { nombre: "Jorge (Camarena)", lat: 40.0333, lng: -4.1667, direccion: "45180, Toledo" },
            { nombre: "Jose Antonio Carretero", lat: 39.105806, lng: -3.180250 },
            { nombre: "Jose Antonio Valverde", lat: 39.126250, lng: -3.097444 },
            { nombre: "Jose Carlos Frances", lat: 39.251417, lng: -3.905528 },
            { nombre: "Jose Enrique Molina", lat: 39.736389, lng: -2.934944 },
            { nombre: "Jose Espadas", lat: 39.921306, lng: -3.024528 },
            { nombre: "Jose Fernando Santos", lat: 39.252667, lng: -3.877000 },
            { nombre: "Jose Lominchar (Corral de Almaguer)", lat: 39.760889, lng: -3.174972 },
            { nombre: "Jose Luis Martin (Los Quiles)", lat: 39.253167, lng: -3.989444 },
            { nombre: "Jose Luis Rodriguez Rabadan", lat: 38.932028, lng: -3.194972 },
            { nombre: "Jose Ramon Lopez (Calera y Chozas)", lat: 39.879250, lng: -4.971361 },
            { nombre: "Jose Ramon Rodrigo", lat: 39.207028, lng: -3.396806 },
            { nombre: "Juan Carlos (Villarejo de Fuentes)", lat: 39.780833, lng: -2.698778 },
            { nombre: "Juan Carlos Hontanilla (Horcajo)", lat: 39.282528, lng: -4.645194 },
            { nombre: "Juan Pedro Infantes", lat: 38.889556, lng: -4.143250 },
            { nombre: "Julian Mateos Valverde", lat: 39.139861, lng: -3.286000 },
            { nombre: "La Casa del Abogado", lat: 39.523306, lng: -3.760417 },
            { nombre: "La Gineta GB", lat: 39.112750, lng: -2.059500 },
            { nombre: "La Majada Manchega", lat: 39.714750, lng: -2.826889 },
            { nombre: "La Marantona 2", lat: 38.876500, lng: -3.175250 },
            { nombre: "Lagasca 91", lat: 39.056944, lng: -3.022444 },
            { nombre: "Laura y Carlos San Clemente", lat: 39.380278, lng: -2.441139 },
            { nombre: "Lazaro", lat: 39.991056, lng: -3.183278 },
            { nombre: "Llabrimen", lat: 39.0731, lng: -3.6136, direccion: "Av La Innovacion, 13, Daimiel" },
            { nombre: "Lorenzo Sanchez", lat: 38.818778, lng: -2.108806 },
            { nombre: "Los Patino Santa Maria del Campo", lat: 39.553056, lng: -2.417667 },
            { nombre: "Luis Checa", lat: 39.622250, lng: -3.212778 },
            { nombre: "Luis Santos", lat: 39.240417, lng: -3.863889 },
            { nombre: "Madridejos, Angel Luis Alcobendas", lat: 39.483194, lng: -3.544861 },
            { nombre: "Manuel Camacho", lat: 39.2000, lng: -3.5000, direccion: "C. Cervantes, 182" },
            { nombre: "Manuel Corral", lat: 38.771306, lng: -3.777389 },
            { nombre: "Manuel Maestre, Malagon", lat: 39.190667, lng: -3.826028 },
            { nombre: "Manuel Urena", lat: 38.870306, lng: -3.686222 },
            { nombre: "Maria Belen Sanchez", lat: 39.704000, lng: -4.188083 },
            { nombre: "Maria Benita (Explotacion)", lat: 39.6833, lng: -3.1000, direccion: "C. Romeral, 2" },
            { nombre: "Maria Benita (Villa de Don Fadrique)", lat: 39.6167, lng: -3.2167, direccion: "C. de la Zarzas, 2-8" },
            { nombre: "Maria Jose Egido (Santa Cruz de Mudela)", lat: 38.621306, lng: -3.485389 },
            { nombre: "Nieto e Hijos", lat: 38.977694, lng: -3.393028 },
            { nombre: "Noelia Merino", lat: 39.264611, lng: -3.931750 },
            { nombre: "Olmo Ganaderos", lat: 39.250167, lng: -3.914667 },
            { nombre: "Oscar Sanchez", lat: 39.247639, lng: -3.859028 },
            { nombre: "Oveman Villaescusa de Haro", lat: 39.5833, lng: -2.4833, direccion: "16647 Villaescusa de Haro" },
            { nombre: "Ovinos Lacaunes (Fuente El Fresno)", lat: 39.219528, lng: -3.788194 },
            { nombre: "Palacio y Morcillo (La Yunquera)", lat: 38.921056, lng: -2.244472 },
            { nombre: "Pedro Antonio Garcia Galan", lat: 39.233000, lng: -3.791528 },
            { nombre: "Pedro Iglesias (Corral de Almaguer)", lat: 39.766861, lng: -3.161944 },
            { nombre: "Pedro Jose Nova Patino", lat: 38.654583, lng: -3.069722 },
            { nombre: "Pedriza de la Fuente", lat: 39.2167, lng: -3.5833, direccion: "13670 Villarrubia de los Ojos" },
            { nombre: "Piensos Hortelano 2", lat: 39.2000, lng: -2.1500, direccion: "02630 La Roda" },
            { nombre: "Piensos Hortelano, La Roda", lat: 39.2000, lng: -2.1500, direccion: "C. Perez Galdos, 38" },
            { nombre: "Poli Leganiel", lat: 40.0333, lng: -2.9167, direccion: "Carretera de Barajas, 10" },
            { nombre: "Queseria El Fraile", lat: 39.508833, lng: -2.999611 },
            { nombre: "Queseria Hontanar", lat: 39.6000, lng: -4.4500, direccion: "45159 Hontanar, Toledo" },
            { nombre: "Quesos Las Tinajuelas", lat: 38.759944, lng: -3.759250 },
            { nombre: "Rafael Diaz (Montiel)", lat: 38.717722, lng: -2.892444 },
            { nombre: "Rafael Minano, Santa Maria del Campo Rus", lat: 39.6167, lng: -2.3833, direccion: "C. Convento, 37" },
            { nombre: "Ramon e Hijos", lat: 39.297639, lng: -3.138139 },
            { nombre: "Reyes y Luis Moral", lat: 39.6500, lng: -2.5833, direccion: "C. Mayor, 45-39, Tresjuncos" },
            { nombre: "Rodrigo, Gabaldon", lat: 39.6333, lng: -2.3500, direccion: "Lugar Calvo Sotelo, 1" },
            { nombre: "Romegil", lat: 39.1667, lng: -3.8500, direccion: "13429 Malagon" },
            { nombre: "Rusticas Arevalo", lat: 38.7167, lng: -3.0000, direccion: "13320 Villanueva de los Infantes" },
            { nombre: "S.A.T El Alamillo", lat: 38.9833, lng: -3.7167, direccion: "C. Tonel, 13300 Valdepenas" },
            { nombre: "Saanencapri", lat: 39.306528, lng: -3.444972 },
            { nombre: "San Clemente 2 Melgarejo", lat: 39.438861, lng: -2.461278 },
            { nombre: "Santiago de la Osada", lat: 39.986500, lng: -3.178000 },
            { nombre: "Santiago Peral", lat: 39.245611, lng: -3.873667 },
            { nombre: "Soledad Magan Carrasco", lat: 40.157528, lng: -2.037917 },
            { nombre: "Supermercado Hermanas Alfredo Oliva", lat: 39.460917, lng: -3.613806 },
            { nombre: "Tarazona de La Mancha", lat: 39.245167, lng: -1.922778 },
            { nombre: "Torrecilla y Albala", lat: 38.9833, lng: -3.9167, direccion: "13005 Ciudad Real" },
            { nombre: "Valdeverdeja", lat: 39.787750, lng: -5.246556 },
            { nombre: "VALLEHERMOSO (Llanos del Caudillo)", lat: 39.105333, lng: -3.330917 },
            { nombre: "Vicente Gutierrez (Los Yebenes)", lat: 39.570972, lng: -3.883444 },
            { nombre: "Vicente Jimenez", lat: 38.942139, lng: -3.366250 },
            { nombre: "Vicente Martinez Torrijos", lat: 39.982778, lng: -3.196722 },
            { nombre: "Villar del Pozo Transpiedrabuena", lat: 38.9167, lng: -3.8500, direccion: "13431 Villar del Pozo" }
        ];

        // Province detection
        function getProvince(lat, lng) {
            if (lng < -5) return 'Badajoz';
            if (lng < -4.5) return 'Toledo';
            if (lat > 39.5 && lng < -3.0 && lng > -4.5) return 'Toledo';
            if (lng > -2.5 && lat > 39.4) return 'Cuenca';
            if (lng > -2.5 && lat < 39.4) return 'Albacete';
            if (lat > 39.5 && lng > -3.5 && lng < -2.5) return 'Cuenca';
            return 'Ciudad Real';
        }

        // Add province to data
        const data = ganaderias.map(g => ({
            ...g,
            provincia: getProvince(g.lat, g.lng)
        }));

        // ========== MAP SETUP ==========
        const map = L.map('map', { zoomControl: true }).setView([39.3, -3.2], 8);

        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; OpenStreetMap &copy; CARTO',
            maxZoom: 19
        }).addTo(map);

        // Custom icon
        const createIcon = (active = false) => L.divIcon({
            className: `marker-pin ${active ? 'active' : ''}`,
            iconSize: [24, 32],
            iconAnchor: [12, 32],
            popupAnchor: [0, -32]
        });

        // ========== CLUSTER ==========
        const markerCluster = L.markerClusterGroup({
            maxClusterRadius: 50,
            spiderfyOnMaxZoom: true,
            showCoverageOnHover: false,
            zoomToBoundsOnClick: true,
            disableClusteringAtZoom: 12
        });
        map.addLayer(markerCluster);

        // ========== STATE ==========
        const markers = [];
        let activeProvince = null;
        let activeMarkerIndex = null;
        let searchTimeout = null;

        // ========== RENDER ==========
        function createPopup(g) {
            const url = `https://www.google.com/maps?q=${g.lat},${g.lng}`;
            return `
                <div class="popup-inner">
                    <div class="popup-header">
                        <div class="popup-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/>
                                <polyline points="9 22 9 12 15 12 15 22"/>
                            </svg>
                        </div>
                        <div class="popup-title">
                            <h3>${g.nombre}</h3>
                            <p>${g.provincia}${g.direccion ? ' - ' + g.direccion : ''}</p>
                        </div>
                    </div>
                    <a href="${url}" target="_blank" class="popup-btn">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/>
                            <circle cx="12" cy="10" r="3"/>
                        </svg>
                        Abrir en Google Maps
                    </a>
                </div>
            `;
        }

        function createListItem(g, index) {
            const url = `https://www.google.com/maps?q=${g.lat},${g.lng}`;
            const div = document.createElement('div');
            div.className = 'list-item';
            div.setAttribute('role', 'listitem');
            div.setAttribute('tabindex', '0');
            div.setAttribute('aria-label', `${g.nombre}, ${g.provincia}`);
            div.innerHTML = `
                <div class="list-item-header">
                    <div class="list-item-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/>
                            <polyline points="9 22 9 12 15 12 15 22"/>
                        </svg>
                    </div>
                    <div class="list-item-content">
                        <div class="list-item-name">${g.nombre}</div>
                        <div class="list-item-location">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/>
                                <circle cx="12" cy="10" r="3"/>
                            </svg>
                            ${g.provincia}${g.direccion ? ' - ' + g.direccion : ''}
                        </div>
                    </div>
                </div>
                <div class="list-item-actions">
                    <a href="${url}" target="_blank" class="btn-maps" onclick="event.stopPropagation()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/>
                            <circle cx="12" cy="10" r="3"/>
                        </svg>
                        Google Maps
                    </a>
                </div>
            `;

            const handleSelect = () => {
                setActive(index);
                map.setView([g.lat, g.lng], 14, { animate: true });
                markers[index].marker.openPopup();

                // On mobile, switch to map view
                if (window.innerWidth <= 768) {
                    showView('map');
                }
            };

            div.addEventListener('click', handleSelect);
            div.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    handleSelect();
                }
            });

            return div;
        }

        function setActive(index) {
            // Reset previous
            if (activeMarkerIndex !== null) {
                markers[activeMarkerIndex].marker.setIcon(createIcon(false));
                const prevItem = document.querySelector('.list-item.active');
                if (prevItem) prevItem.classList.remove('active');
            }

            // Set new
            activeMarkerIndex = index;
            markers[index].marker.setIcon(createIcon(true));
            const items = document.querySelectorAll('.list-item');
            if (items[index]) {
                items[index].classList.add('active');
                items[index].scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }

        function initFilters() {
            const container = document.getElementById('filters');
            const counts = {};
            data.forEach(g => counts[g.provincia] = (counts[g.provincia] || 0) + 1);

            // All button
            const allBtn = document.createElement('button');
            allBtn.className = 'filter-btn active';
            allBtn.dataset.province = 'all';
            allBtn.innerHTML = `Todas <span class="count">${data.length}</span>`;
            allBtn.onclick = () => filterByProvince('all');
            container.appendChild(allBtn);

            // Province buttons
            Object.entries(counts)
                .sort((a, b) => b[1] - a[1])
                .forEach(([prov, count]) => {
                    const btn = document.createElement('button');
                    btn.className = 'filter-btn';
                    btn.dataset.province = prov;
                    btn.innerHTML = `${prov} <span class="count">${count}</span>`;
                    btn.onclick = () => filterByProvince(prov);
                    container.appendChild(btn);
                });
        }

        function filterByProvince(province) {
            activeProvince = province === 'all' ? null : province;

            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.province === province);
            });

            applyFilters();
        }

        function applyFilters() {
            const search = normalize(document.getElementById('searchInput').value);
            const list = document.getElementById('listContainer');
            const items = list.querySelectorAll('.list-item');
            let count = 0;

            // Batch DOM operations
            const toAdd = [];
            const toRemove = [];

            items.forEach((item, i) => {
                const g = data[i];
                const matchSearch = normalize(g.nombre).includes(search) ||
                                   normalize(g.direccion || '').includes(search);
                const matchProv = !activeProvince || g.provincia === activeProvince;
                const show = matchSearch && matchProv;

                item.style.display = show ? '' : 'none';

                if (show) {
                    count++;
                    if (!markerCluster.hasLayer(markers[i].marker)) {
                        toAdd.push(markers[i].marker);
                    }
                } else {
                    if (markerCluster.hasLayer(markers[i].marker)) {
                        toRemove.push(markers[i].marker);
                    }
                }
            });

            // Batch add/remove markers for performance
            if (toRemove.length) markerCluster.removeLayers(toRemove);
            if (toAdd.length) markerCluster.addLayers(toAdd);

            document.getElementById('resultsCount').innerHTML =
                `<strong>${count}</strong> de <strong>${data.length}</strong> ganaderias`;

            // Show/hide clear button
            document.getElementById('btnClear').classList.toggle('show',
                document.getElementById('searchInput').value.length > 0);
        }

        function normalize(str) {
            return str.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
        }

        function init() {
            const list = document.getElementById('listContainer');
            const fragment = document.createDocumentFragment();

            data.forEach((g, i) => {
                // Create marker
                const marker = L.marker([g.lat, g.lng], { icon: createIcon() });
                marker.bindPopup(createPopup(g), { maxWidth: 300 });
                marker.on('click', () => {
                    setActive(i);
                    // Zoom to marker when clicked in cluster
                    map.setView([g.lat, g.lng], 14, { animate: true });
                });
                markers.push({ marker, data: g });
                markerCluster.addLayer(marker);

                // Create list item using fragment for better performance
                fragment.appendChild(createListItem(g, i));
            });

            list.appendChild(fragment);
            initFilters();
            applyFilters();
        }

        // ========== EVENTS ==========
        // Debounced search for better performance
        document.getElementById('searchInput').addEventListener('input', () => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(applyFilters, 150);
        });

        document.getElementById('btnClear').addEventListener('click', () => {
            document.getElementById('searchInput').value = '';
            applyFilters();
            document.getElementById('searchInput').focus();
        });

        document.getElementById('btnCenter').addEventListener('click', () => {
            map.setView([39.3, -3.2], 8, { animate: true });
        });

        document.getElementById('btnFit').addEventListener('click', () => {
            const visible = markers.filter((_, i) =>
                document.querySelectorAll('.list-item')[i].style.display !== 'none'
            );
            if (visible.length) {
                const bounds = visible.map(m => [m.data.lat, m.data.lng]);
                map.fitBounds(bounds, { padding: [50, 50], animate: true });
            }
        });

        // Geolocation
        let userMarker = null;
        document.getElementById('btnLocation').addEventListener('click', () => {
            if (!navigator.geolocation) {
                alert('Tu navegador no soporta geolocalización');
                return;
            }

            const btn = document.getElementById('btnLocation');
            btn.style.color = 'var(--primary-600)';

            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    const { latitude, longitude } = pos.coords;

                    // Remove previous marker
                    if (userMarker) map.removeLayer(userMarker);

                    // Add user marker
                    userMarker = L.circleMarker([latitude, longitude], {
                        radius: 10,
                        fillColor: '#4285f4',
                        fillOpacity: 1,
                        color: 'white',
                        weight: 3
                    }).addTo(map);

                    userMarker.bindPopup('<strong>Tu ubicación</strong>').openPopup();
                    map.setView([latitude, longitude], 10, { animate: true });

                    btn.style.color = '';
                },
                (err) => {
                    btn.style.color = '';
                    alert('No se pudo obtener tu ubicación');
                },
                { enableHighAccuracy: true, timeout: 10000 }
            );
        });

        // ========== MOBILE NAV ==========
        function showView(view) {
            const sidebar = document.getElementById('sidebar');
            const mapContainer = document.getElementById('mapContainer');
            const navMap = document.getElementById('navMap');
            const navList = document.getElementById('navList');

            if (view === 'map') {
                sidebar.classList.add('hide');
                mapContainer.classList.add('show');
                navMap.classList.add('active');
                navList.classList.remove('active');
                map.invalidateSize();
            } else {
                sidebar.classList.remove('hide');
                mapContainer.classList.remove('show');
                navMap.classList.remove('active');
                navList.classList.add('active');
            }
        }

        document.getElementById('navMap').addEventListener('click', () => showView('map'));
        document.getElementById('navList').addEventListener('click', () => showView('list'));

        // Handle resize
        window.addEventListener('resize', () => {
            if (window.innerWidth > 768) {
                document.getElementById('sidebar').classList.remove('hide');
                document.getElementById('mapContainer').classList.remove('show');
            }
            map.invalidateSize();
        });

        // Init
        init();
    </script>
</body>
</html>
